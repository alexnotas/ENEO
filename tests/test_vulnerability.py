import unittest
import sys
import os
import logging
from flask import Flask

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Import the app factory or app object
try:
    from app import app
except ImportError:
    raise ImportError("Could not import 'app'. Ensure run from project root.")

class TestVulnerabilityScenarios(unittest.TestCase):
    """
    Tests for Population Vulnerability Scenarios (Berlin, London, Rio) from Table 5.
    """
    
    def setUp(self):
        # Suppress all logging (including economic data logs)
        logging.disable(logging.CRITICAL)
        
        self.app = app.test_client()
        self.app.testing = True
        
        # Common Parameters
        self.common_params = {
            "velocity": 20,
            "entry_angle": 45,
            "density": 3100,
            "distance": 10
        }

    def tearDown(self):
        # Re-enable logging after tests
        logging.disable(logging.NOTSET)

    def run_simulation(self, params):
        response = self.app.post('/simulate', json=params)
        self.assertEqual(response.status_code, 200, f"Simulation failed: {response.data}")
        data = response.get_json()
        return data['results_data']['population_analysis']['total_casualties']

    def print_result(self, params, casualties, city):
        print(f"\n{city}")
        print(f"Coordinates: {params['latitude']}, {params['longitude']}")
        print(f"Parameters: D={params['diameter']}m, v={params['velocity']}km/s, rho={params['density']}kg/m3, angle={params['entry_angle']}")
        print(f"Estimated Casualties: {casualties:,.0f}")

    def test_berlin_airburst(self):
        """Berlin, 50 m (airburst)"""
        params = {
            **self.common_params,
            "diameter": 50,
            "latitude": 52.51,
            "longitude": 13.40
        }
        casualties = self.run_simulation(params)
        self.print_result(params, casualties, "Berlin (Airburst)")

    def test_berlin_ground(self):
        """Berlin, 200 m (ground impact)"""
        params = {
            **self.common_params,
            "diameter": 200,
            "latitude": 52.51,
            "longitude": 13.40
        }
        casualties = self.run_simulation(params)
        self.print_result(params, casualties, "Berlin (Ground Impact)")

    def test_london_airburst(self):
        """London, 50 m (airburst)"""
        params = {
            **self.common_params,
            "diameter": 50,
            "latitude": 51.50,
            "longitude": -0.10
        }
        casualties = self.run_simulation(params)
        self.print_result(params, casualties, "London (Airburst)")

    def test_london_ground(self):
        """London, 200 m (ground impact)"""
        params = {
            **self.common_params,
            "diameter": 200,
            "latitude": 51.50,
            "longitude": -0.10
        }
        casualties = self.run_simulation(params)
        self.print_result(params, casualties, "London (Ground Impact)")

    def test_rio_ground(self):
        """Rio de Janeiro, 200 m (ground impact)"""
        params = {
            **self.common_params,
            "diameter": 200,
            "latitude": -22.98,
            "longitude": -43.22
        }
        casualties = self.run_simulation(params)
        self.print_result(params, casualties, "Rio de Janeiro (Ground Impact)")

if __name__ == '__main__':
    unittest.main()
