import sys
import os
import logging
import time

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from app import app


def build_client():
    logging.disable(logging.CRITICAL)
    client = app.test_client()
    client.testing = True
    return client


def run_simulation(client, params):
    response = client.post('/simulate', json=params)
    if response.status_code != 200:
        raise RuntimeError(f"Simulation failed: {response.data}")
    data = response.get_json()
    return data['results_data']['population_analysis']['total_casualties']


def print_result(params, casualties, city, duration=None):
    print(f"\n{city}")
    print(f"Coordinates: {params['latitude']}, {params['longitude']}")
    print(
        f"Parameters: D={params['diameter']}m, v={params['velocity']}km/s, "
        f"rho={params['density']}kg/m3, angle={params['entry_angle']}"
    )
    print(f"Estimated Casualties: {casualties:,.0f}")
    if duration is not None:
        print(f"Simulation Time: {duration:.4f} s")


def run_all_scenarios():
    client = build_client()
    common_params = {
        "velocity": 20,
        "entry_angle": 45,
        "density": 3100,
        "distance": 10
    }

    scenarios = [
        ("Berlin (Airburst)", {**common_params, "diameter": 50, "latitude": 52.51, "longitude": 13.40}),
        ("Berlin (Ground Impact)", {**common_params, "diameter": 200, "latitude": 52.51, "longitude": 13.40}),
        ("London (Airburst)", {**common_params, "diameter": 50, "latitude": 51.50, "longitude": -0.10}),
        ("London (Ground Impact)", {**common_params, "diameter": 200, "latitude": 51.50, "longitude": -0.10}),
        ("Rio de Janeiro (Ground Impact)", {**common_params, "diameter": 200, "latitude": -22.98, "longitude": -43.22}),
    ]

    for label, params in scenarios:
        start_time = time.time()
        casualties = run_simulation(client, params)
        end_time = time.time()
        print_result(params, casualties, label, duration=end_time - start_time)


def main():
    try:
        run_all_scenarios()
    finally:
        logging.disable(logging.NOTSET)


if __name__ == '__main__':
    main()
